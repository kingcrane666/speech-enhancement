#include "fft320.h"

Float32 cos_tab1[5][5], sin_tab1[5][5];
Float32 cos_tab2[160], sin_tab2[160];

const Word16 rev[320]={
0,64,128,192,256,32,96,160,224,288,16,80,144,208,272,48,112,176,240,304,8,72,136,200,264,40,104,168,232,296,
24,88,152,216,280,56,120,184,248,312,4,68,132,196,260,36,100,164,228,292,20,84,148,212,276,52,116,180,244,308,
12,76,140,204,268,44,108,172,236,300,28,92,156,220,284,60,124,188,252,316,2,66,130,194,258,34,98,162,226,290,
18,82,146,210,274,50,114,178,242,306,10,74,138,202,266,42,106,170,234,298,26,90,154,218,282,58,122,186,250,314,
6,70,134,198,262,38,102,166,230,294,22,86,150,214,278,54,118,182,246,310,14,78,142,206,270,46,110,174,238,302,
30,94,158,222,286,62,126,190,254,318,1,65,129,193,257,33,97,161,225,289,17,81,145,209,273,49,113,177,241,305,
9,73,137,201,265,41,105,169,233,297,25,89,153,217,281,57,121,185,249,313,5,69,133,197,261,37,101,165,229,293,
21,85,149,213,277,53,117,181,245,309,13,77,141,205,269,45,109,173,237,301,29,93,157,221,285,61,125,189,253,317,
3,67,131,195,259,35,99,163,227,291,19,83,147,211,275,51,115,179,243,307,11,75,139,203,267,43,107,171,235,299,
27,91,155,219,283,59,123,187,251,315,7,71,135,199,263,39,103,167,231,295,23,87,151,215,279,55,119,183,247,311,
15,79,143,207,271,47,111,175,239,303,31,95,159,223,287,63,127,191,255,319};

void fft_320_init(void)
{
	Word16 j, k;
	for(k=0; k<160; k++)
	{
	    cos_tab2[k]=(Float32)cos(2*PI*k/(2*160));
	    sin_tab2[k]=(Float32)sin(2*PI*k/(2*160));
	}
    for(k=0; k<5; k++)
	{
	    for(j=0; j<5; j++) cos_tab1[k][j]=(Float32)cos(2*PI*k*j/5);
	    for(j=0; j<5; j++) sin_tab1[k][j]=(Float32)sin(2*PI*k*j/5);
	}
}


void fft_320(Float32 *tmp1, Float32 *tmp2)
{
    Word16 i, k, j, L, b, r, m;
	Float32 acc2, acc3, x_re[320], x_im[320],x_re1[320], x_im1[320], tr, ti, sr,si, rr, ri;

    for(i=0; i<320; i++) x_re1[i]=tmp1[rev[i]];
	for(i=0; i<320; i++) x_im1[i]=tmp2[rev[i]];

    for(i=0; i<64; i++)
	{
		for(k=0; k<5; k++)
		{
			for(acc2=0.0f, j=0; j<5; j++) acc2 += x_re1[j+i*5]*cos_tab1[k][j]-x_im1[j+i*5]*sin_tab1[k][j];
			x_re[k+i*5] = acc2;
			for(acc3=0.0f, j=0; j<5; j++) acc3 += x_re1[j+i*5]*sin_tab1[k][j]+x_im1[j+i*5]*cos_tab1[k][j];
			x_im[k+i*5] = acc3;
		}
	}

	for(b=L=1; L<7; L++)
	{
		b=2*b;//b=2^L
		m=5*(b/2);
		for(j=0; j<(64/b); j++)
		{
			for(i=0; i<m; i++)
			{
				r=i*64/b;

				rr=cos_tab2[r];
				ri=sin_tab2[r];
                
                tr=x_re[j*2*m+i];
				ti=x_im[j*2*m+i];
				sr=x_re[j*2*m+i+m];
				si=x_im[j*2*m+i+m];

				x_re[j*2*m+i]  =tr+sr*rr-si*ri;
				x_im[j*2*m+i]  =ti+sr*ri+si*rr;
				x_re[j*2*m+i+m]=tr-sr*rr+si*ri;
                x_im[j*2*m+i+m]=ti-sr*ri-si*rr;
			}
		}
	}

	memcpy(tmp1, x_re, 320*4);
	memcpy(tmp2, x_im, 320*4);
}
